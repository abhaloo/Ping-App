/* eslint-disable prettier/prettier */
import React, {Component} from 'react';
import {StyleSheet, Text, View, DeviceEventEmitter} from 'react-native';
import {connect} from "react-redux";
import Map from './Map';

//dispatch props for the class
interface StateProps {
  friendChannel: any
}

class MapScreen extends Component<StateProps> {
  constructor() {
    super();

    // set default location
    let region = {
      latitude: -6.135730,
      longitude: 39.362122,
      latitudeDelta: 0,
      longitudeDelta: 0,
    };

    this.state = {
      region,
    };
  }

  componentWillUnmount() {
    DeviceEventEmitter.emit('unsubscribe', {
      unsubscribe: true,
    });
  }

  componentDidMount() {
    const { channel } = this.props.friendChannel;
    if (channel) {
      channel.bind('client-location-changed', (data) => {
        console.log("data: \n" + data);
        this.setState({
          region: data,
        });
      });
    }
  }

  componentDidUpdate(prevProps: Readonly<P>, prevState: Readonly<S>, snapshot: SS): void {
    const { channel } = this.props.friendChannel;
    if (channel) {
      channel.bind('client-location-changed', (data) => {
        this.setState({
          region: data,
        });
      });
    }
  }

  render() {
    return (
      <View style={styles.map_container}>
        {this.state.region && <Map region={this.state.region} />}
      </View>
    );
  }
}

const styles = StyleSheet.create({
  map_container: {
    ...StyleSheet.absoluteFillObject,
    justifyContent: 'flex-end',
  },
});

//Map the redux store state to the props of the class
//Basically retrieving information back from the redux store
function mapStateToProps(state) {
  return {
    friendChannel: state?.system?.friendChannel
  }
}


export default connect(mapStateToProps, null)(MapScreen);

//Friend Channel passed in
//{"callbacks": {"_callbacks": {"_pusher:subscription_succeeded": [Array]}}, "failThrough": [Function anonymous], "global_callbacks": [], "name": "private-friend-101010708514569", "pusher": {"channels": {"channels": [Object]}, "config": {"activityTimeout": 120000, "auth": [Object], "authEndpoint": "https://location-sharer.abhaloo.vercel.app/pusher/auth", "authTransport": "ajax", "cluster": "ap2", "enableStats": false, "httpHost": "sockjs-ap2.pusher.com", "httpPath": "/pusher", "httpPort": 80, "httpsPort": 443, "nacl": [Object], "pongTimeout": 30000, "statsHost": "stats.pusher.com", "unavailableTimeout": 10000, "useTLS": true, "wsHost": "ws-ap2.pusher.com", "wsPath": "", "wsPort": 80, "wssPort": 443}, "connection": {"callbacks": [t], "connection": null, "connectionCallbacks": [Object], "errorCallbacks": [Object], "failThrough": undefined, "global_callbacks": [Array], "handshakeCallbacks": [Object], "key": "1104307", "options": [Object], "runner": null, "state": "disconnected", "strategy": [t], "timeline": [t], "unavailableTimer": [n], "usingTLS": true}, "global_emitter": {"callbacks": [t], "failThrough": undefined, "global_callbacks": [Array]}, "key": "1104307", "sessionID": 843516805, "timeline": {"events": [Array], "key": "1104307", "options": [Object], "sent": 0, "session": 843516805, "uniqueID": 1}}, "subscribed": false, "subscriptionCancelled": false, "subscriptionPending": false}

//Friend Channel from the MapPage
// {"callbacks":{"_callbacks":{"_pusher:subscription_succeeded":[{}]}},"global_callbacks":[],"name":"private-friend-3432001873574738","pusher":{"key":"1104307","config":{"activityTimeout":120000,"authEndpoint":"https://location-sharer.abhaloo.vercel.app/pusher/auth","authTransport":"ajax","cluster":"ap2","httpPath":"/pusher","httpPort":80,"httpsPort":443,"pongTimeout":30000,"statsHost":"stats.pusher.com","unavailableTimeout":10000,"wsPath":"","wsPort":80,"wssPort":443,"enableStats":false,"httpHost":"sockjs-ap2.pusher.com","useTLS":true,"wsHost":"ws-ap2.pusher.com","auth":{"params":{"app_key":"Bmce+9aHdOoVtE7fS3B07tfj7Bc="}},"nacl":{"lowlevel":{"crypto_secretbox_KEYBYTES":32,"crypto_secretbox_NONCEBYTES":24,"crypto_secretbox_ZEROBYTES":32,"crypto_secretbox_BOXZEROBYTES":16,"crypto_scalarmult_BYTES":32,"crypto_scalarmult_SCALARBYTES":32,"crypto_box_PUBLICKEYBYTES":32,"crypto_box_SECRETKEYBYTES":32,"crypto_box_BEFORENMBYTES":32,"crypto_box_NONCEBYTES":24,"crypto_box_ZEROBYTES":32,"crypto_box_BOXZEROBYTES":16,"crypto_sign_BYTES":64,"crypto_sign_PUBLICKEYBYTES":32,"crypto_sign_SECRETKEYBYTES":64,"crypto_sign_SEEDBYTES":32,"crypto_hash_BYTES":64,"D":{"0":30883,"1":4953,"2":19914,"3":30187,"4":55467,"5":16705,"6":2637,"7":112,"8":59544,"9":30585,"10":16505,"11":36039,"12":65139,"13":11119,"14":27886,"15":20995},"L":{"0":237,"1":211,"2":245,"3":92,"4":26,"5":99,"6":18,"7":88,"8":214,"9":156,"10":247,"11":162,"12":222,"13":249,"14":222,"15":20,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":16}}}},"channels":{"channels":{}},"global_emitter":{"callbacks":{"_callbacks":{}},"global_callbacks":[]},"sessionID":75011816,"timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"connection":{"callbacks":{"_callbacks":{"_connected":[{}],"_message":[{}],"_connecting":[{}],"_disconnected":[{}],"_error":[{}]}},"global_callbacks":[],"state":"disconnected","connection":null,"key":"1104307","options":{"timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"activityTimeout":120000,"pongTimeout":30000,"unavailableTimeout":10000,"useTLS":true},"timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"usingTLS":true,"errorCallbacks":{},"connectionCallbacks":{},"handshakeCallbacks":{},"strategy":{"strategy":{"strategy":{"trueBranch":{"strategies":[{"strategies":[{"name":"ws","priority":3,"transport":{"manager":{"options":{"lives":2,"minPingDelay":10000,"maxPingDelay":120000},"livesLeft":1},"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":false}},"minPingDelay":10000,"maxPingDelay":120000,"pingDelay":10000},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"ws-ap2.pusher.com:80","hostTLS":"ws-ap2.pusher.com:443","httpPath":""}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000},{"strategy":{"strategies":[{"trueBranch":{"strategies":[{"strategies":[{"name":"xhr_streaming","priority":1,"transport":{"manager":{"options":{"lives":2,"minPingDelay":10000,"maxPingDelay":120000},"livesLeft":2},"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":true}},"minPingDelay":10000,"maxPingDelay":120000},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"sockjs-ap2.pusher.com:80","hostTLS":"sockjs-ap2.pusher.com:443","httpPath":"/pusher"}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000},{"strategy":{"strategies":[{"name":"xhr_polling","priority":1,"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":true}},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"sockjs-ap2.pusher.com:80","hostTLS":"sockjs-ap2.pusher.com:443","httpPath":"/pusher"}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000},"options":{"delay":4000}}]},"falseBranch":{"strategies":[{"name":"xhr_polling","priority":1,"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":true}},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"sockjs-ap2.pusher.com:80","hostTLS":"sockjs-ap2.pusher.com:443","httpPath":"/pusher"}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000},"options":{"delay":2000}}]},"falseBranch":{"strategies":[{"trueBranch":{"strategies":[{"strategies":[{"name":"xhr_streaming","priority":1,"transport":{"manager":{"options":{"lives":2,"minPingDelay":10000,"maxPingDelay":120000},"livesLeft":2},"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":true}},"minPingDelay":10000,"maxPingDelay":120000},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"sockjs-ap2.pusher.com:80","hostTLS":"sockjs-ap2.pusher.com:443","httpPath":"/pusher"}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000},{"strategy":{"strategies":[{"name":"xhr_polling","priority":1,"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":true}},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"sockjs-ap2.pusher.com:80","hostTLS":"sockjs-ap2.pusher.com:443","httpPath":"/pusher"}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000},"options":{"delay":4000}}]},"falseBranch":{"strategies":[{"name":"xhr_polling","priority":1,"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":true}},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"sockjs-ap2.pusher.com:80","hostTLS":"sockjs-ap2.pusher.com:443","httpPath":"/pusher"}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000}}],"loop":true,"failFast":false,"timeout":15000,"timeoutLimit":60000}}},"transports":{"ws":{"name":"ws","priority":3,"transport":{"manager":{"options":{"lives":2,"minPingDelay":10000,"maxPingDelay":120000},"livesLeft":1},"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":false}},"minPingDelay":10000,"maxPingDelay":120000,"pingDelay":10000},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"ws-ap2.pusher.com:80","hostTLS":"ws-ap2.pusher.com:443","httpPath":""}},"wss":{"name":"wss","priority":3,"transport":{"manager":{"options":{"lives":2,"minPingDelay":10000,"maxPingDelay":120000},"livesLeft":1},"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":false}},"minPingDelay":10000,"maxPingDelay":120000},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"ws-ap2.pusher.com:80","hostTLS":"ws-ap2.pusher.com:443","httpPath":""}},"xhr_streaming":{"name":"xhr_streaming","priority":1,"transport":{"manager":{"options":{"lives":2,"minPingDelay":10000,"maxPingDelay":120000},"livesLeft":2},"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":true}},"minPingDelay":10000,"maxPingDelay":120000},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"sockjs-ap2.pusher.com:80","hostTLS":"sockjs-ap2.pusher.com:443","httpPath":"/pusher"}},"xhr_polling":{"name":"xhr_polling","priority":1,"transport":{"hooks":{"urls":{},"handlesActivityChecks":false,"supportsPing":true}},"options":{"key":"1104307","timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1},"useTLS":true,"hostNonTLS":"sockjs-ap2.pusher.com:80","hostTLS":"sockjs-ap2.pusher.com:443","httpPath":"/pusher"}}},"ttl":1800000,"usingTLS":true,"timeline":{"key":"1104307","session":75011816,"events":[{"instances":1,"timestamp":1606178701591},{"state":"connecting","timestamp":1606178701592},{"cid":1,"transport":"wss","timestamp":1606178701594},{"cid":1,"state":"initialized","timestamp":1606178701594},{"cid":1,"state":"connecting","timestamp":1606178701595},{"cid":1,"state":"open","timestamp":1606178702903},{"state":"disconnected","timestamp":1606178703433},{"cid":1,"state":"closed","params":{"code":4001,"reason":"App key 1104307 not in this cluster. Did you forget to specify the cluster?"},"timestamp":1606178703439}],"options":{"cluster":"ap2","features":["ws"],"params":{},"limit":50,"level":6,"version":"7.0.1"},"sent":0,"uniqueID":1}},"runner":null,"unavailableTimer":{"timer":null}}},"subscribed":false,"subscriptionPending":false,"subscriptionCancelled":false}
